<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://meta-bit.github.io/mconfig/44_design_consolidated.html" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>4.4 Design Consolidated - mConfig Documentation</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "4.4 Design Consolidated";
        var mkdocs_page_input_path = "44_design_consolidated.md";
        var mkdocs_page_url = "/mconfig/44_design_consolidated.html";
      </script>
    
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="index.html" class="icon icon-home"> mConfig Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="index.html">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Part 1 Introduction & Basics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="11_what_is_mconfig.html">1.1 What is mConfig?</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="12_features_and_use_cases.html">1.2 Features and Use Cases</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="13_getting_started.html">1.3 Getting Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="14_regular_use.html">1.4 Regular Use</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="15_test_mode.html">1.5 Test Mode</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Part 2 Core Concepts</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="21_how_it_works.html">2.1 How it Works</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="22_priorities_and_hierarchies.html">2.2 Priorities and Hierarchies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="23_configuration_schemes.html">2.3 Configuration Schemes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="24_comment_handling.html">2.4 Comment Handling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="25_config_features.html">2.5 Config Features</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Part 3 Advanced Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="31_writing_configurations.html">3.1 Writing Configurations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="32_updates.html">3.2 Updates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="33_getting_information.html">3.3 Getting Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="34_definitions_and_valid_values.html">3.4 Definitions and Valid Values</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="35_handling_secrets.html">3.5 Handling Secrets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="36_windows_registry.html">3.6 Windows Registry Access</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="37_extensions_and_advanced_use.html">3.7 Extensions and Advanced Use</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="38_code_improvements.html">3.8 Code Improvements</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Part 4 Reference & Project</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="41_mconfig_tool.html">4.1 mConfig Tool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="42_logging.html">4.2 Logging</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="43_faq.html">4.3 FAQ</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">4.4 Design Consolidated</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#441-overview">4.4.1 Overview</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#4411-multi-platform-portability-goal">4.4.1.1 Multi-Platform Portability Goal</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#core-architectural-principle-layered-stack">Core Architectural Principle: Layered Stack</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#442-scopes-and-priority">4.4.2 Scopes and Priority</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#4421-storage-type-priority">4.4.2.1 Storage Type Priority</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4422-self-configuration">4.4.2.2 Self-Configuration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#44221-library-self-configuration-configfactorysettings">4.4.2.2.1 Library Self-Configuration (ConfigFactorySettings)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#44222-networked-source-self-configuration">4.4.2.2.2 Networked Source Self-Configuration</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#443-core-components">4.4.3 Core Components</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#configfactory">ConfigFactory</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configsearchlist">ConfigSearchList</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configlocation-configsource">ConfigLocation &amp; ConfigSource</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configstorage">ConfigStorage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configformat">ConfigFormat</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configlayer">ConfigLayer</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configentry">ConfigEntry</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#444-operational-modes">4.4.4 Operational Modes</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#test_mode">TEST_MODE</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#additional_directories">ADDITIONAL_DIRECTORIES</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#service-mode-auto-refresh-monitoring">SERVICE-mode (Auto-refresh &amp; Monitoring)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4442-self-configuration-security">4.4.4.2 Self-Configuration Security</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#445-reading-and-writing">4.4.5 Reading and Writing</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#reading">Reading</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#writing">Writing</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#446-security-and-secrets">4.4.6 Security and Secrets</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#4461-secret-entries">4.4.6.1 Secret Entries</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4462-scheme-driven-secrets">4.4.6.2 Scheme-Driven Secrets</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4463-external-secrets-providers">4.4.6.3 External Secrets Providers</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#447-format-specifics">4.4.7 Format Specifics</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#java-properties">Java .properties</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#json-json5">JSON / JSON5</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#yaml">YAML</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ini">INI</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4477-writing-priorities">4.4.7.7 Writing Priorities</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#448-blobs-binary-data">4.4.8 BLOBs (Binary Data)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#4481-hierarchical-blobs-keyed-leaves">4.4.8.1 Hierarchical BLOBs (Keyed Leaves)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4482-flat-blobs-opaque-files">4.4.8.2 Flat BLOBs (Opaque Files)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#449-crypto-library-interaction">4.4.9 Crypto Library Interaction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4410-configuration-schemes">4.4.10 Configuration Schemes</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#44101-discovery-and-precedence">4.4.10.1 Discovery and Precedence</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#44102-discovery-and-binding-flow-mermaid">4.4.10.2 Discovery and Binding Flow (Mermaid)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#layered-configuration-mermaid">Layered Configuration (Mermaid)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4411-extending-mconfig">4.4.11 Extending mConfig</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#44111-adding-new-storages">4.4.11.1 Adding New Storages</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#44112-adding-new-configfeatures">4.4.11.2 Adding New ConfigFeatures</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4412-best-practices">4.4.12 Best Practices</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#classpath-layout">Classpath Layout</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#logging">Logging</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#secrets-handling">Secrets Handling</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="45_ai_guidance.html">4.5 AI Guidance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="46_versions.html">4.6 Versions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="47_contributing.html">4.7 Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="48_legal.html">4.8 Legal</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Examples</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="examples/index.html">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/simple_configuration_loading.html">Simple Configuration Loading</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/advanced_configuration_handling.html">Advanced Configuration Handling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/integration_with_cicd.html">Integration with CI/CD</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/testing_configurations.html">Testing Configurations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/mconfig-modules.html">mConfig Modules</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/java-modules.html">JPMS (Java Modules)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/configuration_views.html">Configuration Views</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/zookeeper.html">ZooKeeper</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/handling_crypto_keys_and_certificates.html">Handling Crypto Keys and Certificates</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="examples/schemes.html">Schemes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="49_links.html">4.9 Links</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">mConfig Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html" class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Part 4 Reference & Project</li>
      <li class="breadcrumb-item active">4.4 Design Consolidated</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="44-mconfig-consolidated-design-document">4.4 mConfig Consolidated Design Document<a class="headerlink" href="#44-mconfig-consolidated-design-document" title="Permanent link">&para;</a></h1>
<h2 id="441-overview">4.4.1 Overview<a class="headerlink" href="#441-overview" title="Permanent link">&para;</a></h2>
<p>mConfig is a modular configuration library for Java, designed for flexibility, 
extensibility, and standardized configuration management 
across different operating systems and environments.</p>
<h3 id="4411-multi-platform-portability-goal">4.4.1.1 Multi-Platform Portability Goal<a class="headerlink" href="#4411-multi-platform-portability-goal" title="Permanent link">&para;</a></h3>
<p>While the primary implementation is in Java, mConfig is designed 
with future ports to other languages (e.g., C, Rust, Python) in mind.
- <strong>Abstraction over Platform Specifics</strong>: Core logic (in <code>mConfigCore</code>) MUST 
remain agnostic of specific packaging formats (like JARs) or environment-specific APIs (like Java ClassLoaders).
- <strong>Module Isolation</strong>: Platform-specific logic (e.g., scanning Java classpath for resources)
must be isolated in dedicated modules (like <code>mConfigSourceJAR</code>).
- <strong>Standardized Interfaces</strong>: Use generic interfaces for discovery and storage
to ensure that the core behavior can be mirrored in other language environments
without significant architectural changes.</p>
<h3 id="core-architectural-principle-layered-stack">Core Architectural Principle: Layered Stack<a class="headerlink" href="#core-architectural-principle-layered-stack" title="Permanent link">&para;</a></h3>
<p>Configurations are resolved through a stack of layers, prioritized by scope specificity.
<strong>Cache (optional) -&gt; Found Sources (ordered by scope) -&gt; Defaults</strong></p>
<h2 id="442-scopes-and-priority">4.4.2 Scopes and Priority<a class="headerlink" href="#442-scopes-and-priority" title="Permanent link">&para;</a></h2>
<p>Scopes define the visibility and precedence of configuration data.</p>
<table>
<thead>
<tr>
<th>Scope</th>
<th>Description</th>
<th>Priority</th>
</tr>
</thead>
<tbody>
<tr>
<td>POLICY</td>
<td>Enforced policy settings (e.g., GPO), overriding everything else.</td>
<td>1 (Highest)</td>
</tr>
<tr>
<td>RUNTIME</td>
<td>Volatile, in-memory settings for the current process.</td>
<td>2</td>
</tr>
<tr>
<td>SESSION</td>
<td>Specific to the current user session or working directory.</td>
<td>3</td>
</tr>
<tr>
<td>USER</td>
<td>Personal settings for the current user (e.g., <code>~/.config/</code>).</td>
<td>4</td>
</tr>
<tr>
<td>APPLICATION</td>
<td>Settings specific to the application installation/portable root.</td>
<td>5</td>
</tr>
<tr>
<td>HOST</td>
<td>Host / OS instance settings (e.g., <code>/etc/</code>, Windows Registry HKLM).</td>
<td>6</td>
</tr>
<tr>
<td>CLUSTER</td>
<td>Settings for a cluster of hosts.</td>
<td>7</td>
</tr>
<tr>
<td>CLOUD</td>
<td>Cloud-based configurations, shared across multiple clusters.</td>
<td>8</td>
</tr>
<tr>
<td>ORGANIZATION</td>
<td>Settings shared across an organization/licensee.</td>
<td>9</td>
</tr>
<tr>
<td>PRODUCT</td>
<td>Hardcoded defaults provided by the application or modules.</td>
<td>10 (Lowest)</td>
</tr>
</tbody>
</table>
<p><strong>Tie-breaking within the same scope:</strong> Later-added layers take precedence over earlier-added ones.</p>
<h3 id="4421-storage-type-priority">4.4.2.1 Storage Type Priority<a class="headerlink" href="#4421-storage-type-priority" title="Permanent link">&para;</a></h3>
<p>Resolution priority between different storage types (within the same scope) is deterministic.</p>
<p><strong>Default Order (Highest to Lowest):</strong>
1. <code>RAM</code> (In-memory overrides)
2. <code>secrets</code> (Encrypted/sensitive data)
3. <code>files</code> (Local filesystem)
4. <code>registry</code> (Windows Registry - JNR-FFI)
5. <code>registryjni</code> (Windows Registry - JNI)
6. <code>zookeeper</code> (ZooKeeper - Experimental, Self-configuring)
7. <code>JAR</code> (Classpath resources/defaults)</p>
<p>This order can be customized via <code>STORAGE_TYPE_PRIORITIES</code> (List of IDs) and <code>STORAGE_TYPE_ALLOW_ALL_STORAGES</code> (Boolean).</p>
<h2 id="4422-self-configuration">4.4.2.2 Self-Configuration<a class="headerlink" href="#4422-self-configuration" title="Permanent link">&para;</a></h2>
<p>mConfig supports "self-configuration" to allow the library to configure 
its own behavior using the same discovery mechanisms it provides to applications.</p>
<h3 id="44221-library-self-configuration-configfactorysettings">4.4.2.2.1 Library Self-Configuration (ConfigFactorySettings)<a class="headerlink" href="#44221-library-self-configuration-configfactorysettings" title="Permanent link">&para;</a></h3>
<p>When the <code>mConfigSourceJAR</code> module is present, mConfig automatically searches
for a properties file named <code>mconfig.properties</code> in the following classpath location:
<code>.config/metabit/mConfig/mconfig.properties</code></p>
<p>This file is used to populate <code>ConfigFactorySettings</code> during the 
<code>ConfigFactory</code> initialization. It supports setting any <code>ConfigFeature</code>.
(Thus, handle with care; it is as powerful as its code counterparts.)</p>
<ul>
<li><strong>Discovery</strong>: It uses <code>ClassLoader.getResources()</code> to find 
<em>all</em> occurrences of this file in the classpath,
allowing settings to be provided from multiple JARs or resource paths.</li>
<li><strong>Format</strong>: Standard Java <code>.properties</code> format only.
Keys (ignoring case) are matched against <code>ConfigFeature</code> constants.</li>
<li><strong>Disabling</strong>: This feature is enabled by default for convenience, but can be disabled via <code>ConfigFeature.ENABLE_SELF_CONFIGURATION = false</code> for environments with strict classpath security requirements.</li>
</ul>
<h3 id="44222-networked-source-self-configuration">4.4.2.2.2 Networked Source Self-Configuration<a class="headerlink" href="#44222-networked-source-self-configuration" title="Permanent link">&para;</a></h3>
<p>Networked sources (like ZooKeeper) can also retrieve their own connection settings (connect string, root path, etc.) from previously loaded layers (e.g., JAR defaults or local filesystem overrides).</p>
<p><strong>Resolution Order during Startup:</strong>
1.  <strong>Core Discovery</strong>: Modules (Storages, Formats) and <code>ConfigFactoryComponent</code>s are identified.
2.  <strong>Library Self-Configuration</strong>: <code>SelfConfigurationComponent</code> (from <code>mConfigSourceJAR</code>) is initialized, populating <code>ConfigFactorySettings</code> from <code>mconfig.properties</code>.
3.  <strong>Local Source Initialization</strong>: <code>JARConfigSource</code> and <code>FileConfigStorage</code> are initialized based on <code>STORAGE_TYPE_PRIORITIES</code>.
4.  <strong>Networked Source Initialization</strong>:
    - <code>ZooKeeperConfigStorage.init()</code> is called.
    - It requests its own configuration (default name: <code>"zookeeper"</code>) from the factory via <code>ctx.getFactory().getConfig("zookeeper")</code>.
    - If settings are found in JAR defaults or local files, it connects and registers its locations (e.g., <code>CLUSTER</code>, <code>ORGANIZATION</code>).
    - If settings are missing, it remains inactive (zero-config support).
5.  <strong>Finalization</strong>: The factory is ready, including any successfully activated networked layers.</p>
<p>See <a href="examples/zookeeper.html">ZooKeeper Example</a> for detailed configuration snippets.</p>
<h2 id="443-core-components">4.4.3 Core Components<a class="headerlink" href="#443-core-components" title="Permanent link">&para;</a></h2>
<h3 id="configfactory">ConfigFactory<a class="headerlink" href="#configfactory" title="Permanent link">&para;</a></h3>
<p>The main entry point. It manages the <code>ConfigSearchList</code> and instantiates <code>Configuration</code> objects.</p>
<h3 id="configsearchlist">ConfigSearchList<a class="headerlink" href="#configsearchlist" title="Permanent link">&para;</a></h3>
<p>A prioritized list of <code>ConfigLocation</code> entries defining where the library should look for configurations.</p>
<h3 id="configlocation-configsource">ConfigLocation &amp; ConfigSource<a class="headerlink" href="#configlocation-configsource" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ConfigLocation</strong>: Defines <em>where</em> a configuration might be found (Storage + Handle + Scope).</li>
<li><strong>ConfigSource</strong>: An instantiated <code>ConfigLocation</code> that is associated with a specific <code>ConfigLayer</code>. It confirms the configuration exists and is readable.</li>
</ul>
<h3 id="configstorage">ConfigStorage<a class="headerlink" href="#configstorage" title="Permanent link">&para;</a></h3>
<p>Provides low-level access to data (e.g., <code>FileConfigStorage</code>, <code>WindowsRegistryConfigStorage</code>, <code>EnvVarConfigStorage</code>).</p>
<h3 id="configformat">ConfigFormat<a class="headerlink" href="#configformat" title="Permanent link">&para;</a></h3>
<p>Parses and writes data in specific formats (e.g., <code>Properties</code>, <code>JSON</code>, <code>YAML</code>, <code>TOML</code>, <code>JSON5</code>, <code>INI</code>). It is responsible for instantiating <code>ConfigLayer</code> objects.</p>
<h3 id="configlayer">ConfigLayer<a class="headerlink" href="#configlayer" title="Permanent link">&para;</a></h3>
<p>A concrete instance of configuration data from a <code>ConfigLocation</code>. It maps hierarchical keys (e.g., <code>database/host</code>) to <code>ConfigEntry</code> objects.</p>
<h3 id="configentry">ConfigEntry<a class="headerlink" href="#configentry" title="Permanent link">&para;</a></h3>
<p>A leaf node in the configuration tree, containing the value and metadata (like the source location).</p>
<h2 id="444-operational-modes">4.4.4 Operational Modes<a class="headerlink" href="#444-operational-modes" title="Permanent link">&para;</a></h2>
<h3 id="test_mode">TEST_MODE<a class="headerlink" href="#test_mode" title="Permanent link">&para;</a></h3>
<ul>
<li>Bypasses standard OS locations.</li>
<li>Uses only explicitly provided test paths (via <code>TESTMODE_DIRECTORIES</code> feature) and standard test resources.</li>
<li><code>TESTMODE_DIRECTORIES</code> entries support the <code>SCOPENAME ":" PATH</code> format.</li>
<li>Prevents tests from interfering with or relying on actual user configurations.</li>
<li><strong>Security</strong>: Employs a two-tier gate system (Global Static Gate + Instance Dynamic Gate). <code>PERMIT_TEST_MODE</code> defaults to <code>true</code> ("Productive by Default") but can be locked down per instance.</li>
</ul>
<h3 id="additional_directories">ADDITIONAL_DIRECTORIES<a class="headerlink" href="#additional_directories" title="Permanent link">&para;</a></h3>
<ul>
<li><code>ADDITIONAL_RUNTIME_DIRECTORIES</code> and <code>ADDITIONAL_USER_DIRECTORIES</code> allow adding custom search paths at runtime.</li>
<li>Support the <code>SCOPENAME ":" PATH</code> format, allowing paths to be assigned to any scope (not just their default scope).</li>
<li>Prepended to the search list of their respective scope, ensuring they take precedence over default locations.</li>
</ul>
<h3 id="service-mode-auto-refresh-monitoring">SERVICE-mode (Auto-refresh &amp; Monitoring)<a class="headerlink" href="#service-mode-auto-refresh-monitoring" title="Permanent link">&para;</a></h3>
<ul>
<li>If enabled, every access re-checks the search list for new or updated configuration files.</li>
<li>Recommended to be used with a <strong>Cache Layer</strong> to mitigate performance overhead.</li>
<li>Cache entries should have a configurable TTL (Time-To-Live).</li>
<li><strong>Monitoring Support</strong>: <code>Configuration</code> supports the <code>subscribeToUpdates(Consumer&lt;ConfigLocation&gt;)</code> mechanism. 
  This is used by the <code>monitor</code> CLI command to provide real-time reporting of changes.</li>
</ul>
<h3 id="4442-self-configuration-security">4.4.4.2 Self-Configuration Security<a class="headerlink" href="#4442-self-configuration-security" title="Permanent link">&para;</a></h3>
<p>Self-configuration (see section 2.2.1) automatically applies settings from the classpath. In environments where the classpath might contain untrusted JARs, this feature can be disabled:</p>
<pre><code class="language-java">ConfigFactoryBuilder.create(&quot;metabit&quot;, &quot;APP&quot;)
    .setFeature(ConfigFeature.ENABLE_SELF_CONFIGURATION, false)
    .build();
</code></pre>
<p>Disabling self-configuration ensures that the <code>ConfigFactory</code> starts with only the settings explicitly provided in code, preventing "configuration injection" via the classpath.</p>
<h2 id="445-reading-and-writing">4.4.5 Reading and Writing<a class="headerlink" href="#445-reading-and-writing" title="Permanent link">&para;</a></h2>
<h3 id="reading">Reading<a class="headerlink" href="#reading" title="Permanent link">&para;</a></h3>
<ul>
<li>Sequential search from most specific to least specific scope.</li>
<li>Value conversion (String to Integer, Boolean, etc.) is handled at the <code>Configuration</code> facade level.</li>
</ul>
<h3 id="writing">Writing<a class="headerlink" href="#writing" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Direct Write</strong>: Attempt to write back to the <code>ConfigLocation</code> where the entry was found.</li>
<li><strong>Scope-based Write</strong>: Specify a scope for the write operation.</li>
<li><strong>Write Fallback (Fall-forward)</strong>: If writing to the preferred location fails, attempt to write to a more specific scope (e.g., if MACHINE is read-only, write to USER).</li>
<li><strong>Write Cache</strong>: Optional layer that buffers writes until a <code>flush()</code> is called.</li>
</ul>
<h2 id="446-security-and-secrets">4.4.6 Security and Secrets<a class="headerlink" href="#446-security-and-secrets" title="Permanent link">&para;</a></h2>
<p>mConfig provides specialized handling for sensitive data (API keys, passwords, certificates).</p>
<h3 id="4461-secret-entries">4.4.6.1 Secret Entries<a class="headerlink" href="#4461-secret-entries" title="Permanent link">&para;</a></h3>
<ul>
<li>Sensitive data should be handled via <code>SecretValue</code> and <code>SecretConfigEntryLeaf</code>.</li>
<li>Values are obfuscated in memory (<code>char[]</code> or <code>byte[]</code> instead of <code>String</code> where possible).</li>
<li><code>toString()</code> implementation of secret entries is automatically redacted (<code>[REDACTED]</code>).</li>
<li><code>ConfigFacadeImpl.getSecret(key)</code> is the preferred API to retrieve a <code>SecretValue</code>.</li>
</ul>
<h3 id="4462-scheme-driven-secrets">4.4.6.2 Scheme-Driven Secrets<a class="headerlink" href="#4462-scheme-driven-secrets" title="Permanent link">&para;</a></h3>
<p>A <code>ConfigEntry</code> is treated as a secret if its <code>ConfigEntrySpecification</code> (from a <code>ConfigScheme</code>) has the <code>SECRET</code> flag set.
- <code>ConfigEntryFactory</code> automatically creates a <code>SecretConfigEntryLeaf</code> if the scheme marks the key as a secret.
- <strong>Intelligent Type Selection</strong>: When creating a secret entry, the factory chooses a <code>SecretType</code> (e.g., <code>PLAIN_TEXT</code> vs <code>SYMMETRIC_KEY</code>) based on the requested <code>ConfigEntryType</code>.</p>
<h3 id="4463-external-secrets-providers">4.4.6.3 External Secrets Providers<a class="headerlink" href="#4463-external-secrets-providers" title="Permanent link">&para;</a></h3>
<p>External authentication (e.g., towards networked sources like HashiCorp Vault) 
can be integrated via specialized modules implementing <code>ConfigSecretsProviderInterface</code>.
- Secret providers are initialized during the configuration loading phase.
- They can receive a <code>ConfigurationPhaseWrapper</code> to access 
partially loaded configurations for their own initialization
(e.g., to read the Vault address from a local file).</p>
<h2 id="447-format-specifics">4.4.7 Format Specifics<a class="headerlink" href="#447-format-specifics" title="Permanent link">&para;</a></h2>
<h3 id="java-properties">Java .properties<a class="headerlink" href="#java-properties" title="Permanent link">&para;</a></h3>
<ul>
<li>Flat key-value pairs. Trims whitespace.</li>
<li>Supports multi-line values with <code>\</code>.</li>
</ul>
<h3 id="json-json5">JSON / JSON5<a class="headerlink" href="#json-json5" title="Permanent link">&para;</a></h3>
<ul>
<li>Toplevel must be an Object or Array.</li>
<li>JSON5 adds support for comments, trailing commas, and unquoted keys.</li>
</ul>
<h3 id="yaml">YAML<a class="headerlink" href="#yaml" title="Permanent link">&para;</a></h3>
<ul>
<li>Supports hierarchical structures.</li>
<li>Implementation must ensure secure parsing (avoiding arbitrary command execution).</li>
</ul>
<h3 id="ini">INI<a class="headerlink" href="#ini" title="Permanent link">&para;</a></h3>
<ul>
<li>Section-based (<code>[section]</code>).</li>
<li>Hierarchical keys can be mapped to sections using <code>/</code> (e.g., <code>[first/second]</code>).</li>
</ul>
<h3 id="4477-writing-priorities">4.4.7.7 Writing Priorities<a class="headerlink" href="#4477-writing-priorities" title="Permanent link">&para;</a></h3>
<p>When writing to a configuration (e.g., via <code>put</code>), mConfig applies the following priorities within the requested scope(s):</p>
<ol>
<li><strong>Priority 1: Update Existing Entry.</strong> The highest-priority writeable layer in the scope that already contains the key is updated.</li>
<li><strong>Priority 2: Add to Existing Layer.</strong> If the key is new to the scope, it is added to the highest-priority writeable layer already instantiated in that scope.</li>
<li><strong>Priority 3: Create New Layer.</strong> If no writeable layers exist for the scope, mConfig attempts to create a new one using the prioritized <code>ConfigStorage</code> and <code>ConfigFormat</code> settings.</li>
</ol>
<p>Writes are strictly scope-isolated unless <code>WRITE_FALLBACK_ACROSS_SCOPES</code> is enabled. For multi-scope writes, mConfig iterates from the most specific to the most generic scope, stopping at the first successful write.</p>
<h2 id="448-blobs-binary-data">4.4.8 BLOBs (Binary Data)<a class="headerlink" href="#448-blobs-binary-data" title="Permanent link">&para;</a></h2>
<p>mConfig supports Binary Large Objects (certs, licenses, keys) in two distinct ways:</p>
<h3 id="4481-hierarchical-blobs-keyed-leaves">4.4.8.1 Hierarchical BLOBs (Keyed Leaves)<a class="headerlink" href="#4481-hierarchical-blobs-keyed-leaves" title="Permanent link">&para;</a></h3>
<p>In hierarchical formats like JSON and YAML, binary data can exist as a leaf node with a specific key (e.g., <code>server/certificate</code>).
- <strong>YAML</strong>: Native support via the <code>!!binary</code> tag.
- <strong>JSON</strong>: Supported via Base64 encoding. If a <code>ConfigScheme</code> marks a key as <code>BYTES</code>, the JSON format will automatically decode the Base64 string into a <code>BlobConfigEntryLeaf</code>.
- These entries are part of the regular configuration tree and can be accessed via <code>getValueAsBytes()</code>.</p>
<h3 id="4482-flat-blobs-opaque-files">4.4.8.2 Flat BLOBs (Opaque Files)<a class="headerlink" href="#4482-flat-blobs-opaque-files" title="Permanent link">&para;</a></h3>
<p>Entire files can be treated as a single binary blob using the <code>FileRawBinaryFormat</code> (extension <code>.bin</code>).
- These are <strong>opaque</strong> and have no internal structure.
- The entry is always accessed using the empty string key (<code>""</code>).
- Requesting any other key from a flat binary layer will return <code>null</code>.</p>
<h2 id="449-crypto-library-interaction">4.4.9 Crypto Library Interaction<a class="headerlink" href="#449-crypto-library-interaction" title="Permanent link">&para;</a></h2>
<p>mConfig is designed to work seamlessly with standard Java crypto libraries (JCE) and third-party libraries like BouncyCastle.</p>
<ul>
<li><strong>JCE Integration</strong>: <code>SecretValue</code> can store raw bytes of <code>PrivateKey</code>, <code>PublicKey</code>, or <code>SecretKey</code>. Conversion typically involves <code>key.getEncoded()</code>.</li>
<li><strong>BouncyCastle</strong>: Can be used to process <code>SecretValue</code> contents (e.g., parsing a PEM-encoded certificate stored as a <code>BYTES</code> entry).</li>
<li><strong>Test Strategy</strong>: Integration tests (<code>SecretsJCETest</code>, <code>SecretsBCTest</code>) verify that low-level binary secrets are preserved exactly as they move through the configuration stack.</li>
</ul>
<h2 id="4410-configuration-schemes">4.4.10 Configuration Schemes<a class="headerlink" href="#4410-configuration-schemes" title="Permanent link">&para;</a></h2>
<p>Configuration Schemes define the contract for a set of configuration entries, specifying keys, types, defaults, and validation rules.</p>
<p>See the detailed <strong><a href="23_configuration_schemes.html">Configuration Schemes</a></strong> for information on:
- Scheme structure and properties
- Future-proofing with the <code>MANDATORY</code> block
- JSON format variants
- Discovery and registration via <code>ConfigSchemeRepository</code></p>
<h3 id="44101-discovery-and-precedence">4.4.10.1 Discovery and Precedence<a class="headerlink" href="#44101-discovery-and-precedence" title="Permanent link">&para;</a></h3>
<p>Schemes are automatically discovered from the classpath (specifically within <code>.config/</code> directories) if the <code>JARConfigSource</code> is active.</p>
<ul>
<li><strong>Unified Discovery:</strong> Discovery is performed across all classpath resources, including both <code>main</code> and <code>test</code> resource directories.</li>
<li><strong>Precedence:</strong> If multiple scheme files for the same configuration name are discovered, a "Last-One-Wins" strategy is applied based on the order returned by the <code>ClassLoader</code>. In typical development environments (Maven/Gradle), this means production resources might overwrite test resources if they appear later in the classpath enumeration.</li>
<li><strong>Scope Agnosticism:</strong> Unlike configuration data (layers), schemes are not scope-isolated in <code>TEST_MODE</code>. Production schemes are always loaded to ensure a consistent contract.</li>
</ul>
<h3 id="44102-discovery-and-binding-flow-mermaid">4.4.10.2 Discovery and Binding Flow (Mermaid)<a class="headerlink" href="#44102-discovery-and-binding-flow-mermaid" title="Permanent link">&para;</a></h3>
<p>The following diagram illustrates how schemes are discovered by storages, registered in the factory, and finally bound to configuration instances.</p>
<pre><code class="language-mermaid">sequenceDiagram
    participant S as ConfigStorage (e.g. JAR)
    participant C as ConfigFactoryInstanceContext
    participant F as ConfigFactory
    participant L as LayeredConfiguration
    participant DL as DefaultLayer

    Note over S, C: Discovery Phase (during Storage.init)
    S-&gt;&gt;C: registerDiscoveredScheme(name, json)

    Note over C, F: Registration Phase (during Factory.init)
    F-&gt;&gt;C: getDiscoveredSchemes()
    F-&gt;&gt;F: addConfigScheme(name, scheme)

    Note over F, L: Binding Phase (during factory.getConfig)
    F-&gt;&gt;L: instantiate with matching scheme
    L-&gt;&gt;DL: transferDefaults(scheme)
</code></pre>
<h3 id="layered-configuration-mermaid">Layered Configuration (Mermaid)<a class="headerlink" href="#layered-configuration-mermaid" title="Permanent link">&para;</a></h3>
<pre><code class="language-mermaid">%%{init: {'theme':'neutral'}}%%
erDiagram
    Configuration ||--|| BasicConfiguration : &quot;facade for&quot;
    BasicConfiguration ||--|| LayeredConfiguration : &quot;implemented by&quot;
    LayeredConfiguration ||--o| CacheLayer : &quot;at top&quot;
    LayeredConfiguration ||--o{ ConfigSource : &quot;stacked in the middle&quot;
    LayeredConfiguration ||--|| DefaultLayer : &quot;at bottom&quot;
    LayeredConfiguration ||--o| ConfigScheme : &quot;bound to&quot;
    ConfigScheme ||--|| DefaultLayer : &quot;populates&quot;
    ConfigScheme ||--o{ ConfigEntrySpecification : &quot;contains&quot;
    ConfigEntry }|--o| ConfigEntrySpecification : &quot;validated by&quot;
    ConfigSource }|--|| ConfigScope : &quot;belongs to&quot;
    ConfigSource ||--|| ConfigLocation : &quot;where to look&quot;
    ConfigSource }o--|| ConfigStorage : &quot;how to access&quot;
    ConfigSource }o--|{ ConfigFormat : &quot;maps paths to entries&quot;
</code></pre>
<h2 id="4411-extending-mconfig">4.4.11 Extending mConfig<a class="headerlink" href="#4411-extending-mconfig" title="Permanent link">&para;</a></h2>
<h3 id="44111-adding-new-storages">4.4.11.1 Adding New Storages<a class="headerlink" href="#44111-adding-new-storages" title="Permanent link">&para;</a></h3>
<p>This is intended for library maintainers extending mConfig with new backends (e.g., databases, cloud stores).</p>
<p>When implementing a new <code>ConfigStorage</code>:</p>
<ol>
<li><strong>Module Creation</strong>: Create <code>mConfigSource&lt;Name&gt;</code> module with <code>ConfigStorageInterface</code> impl.</li>
<li><strong>init(ctx)</strong>: Populate <code>ctx.getSearchList()</code> with <code>ConfigLocationImpl</code> for scopes/formats/paths.</li>
<li><strong>Read Layers</strong>: In <code>tryToReadConfigurationLayers</code>, load/parse entries into <code>LayeredConfiguration</code>.</li>
<li><strong>Classpath Order</strong>: Auto-discovered; control via <code>ConfigFeature.STORAGE_TYPE_PRIORITIES</code>.</li>
<li><strong>Testing</strong>: Add unit/integration tests; verify with full <code>mvn clean test</code>.</li>
</ol>
<p>Examples: <code>FileConfigStorage</code>, <code>JARConfigSource</code>, <code>WindowsRegistryConfigSource</code>.</p>
<p>In case a specific config format is to be supported as well, it can go into the same module.</p>
<h3 id="44112-adding-new-configfeatures">4.4.11.2 Adding New ConfigFeatures<a class="headerlink" href="#44112-adding-new-configfeatures" title="Permanent link">&para;</a></h3>
<p>This is not for library consumers; only project owners should need to perform this step.</p>
<p>When adding a new constant to the <code>ConfigFeature</code> enum in <code>mConfigCore</code>, you MUST perform the following steps to ensure technical consistency and avoid runtime errors:</p>
<ol>
<li><strong>Enum Constant</strong>: Add the new constant to the <code>ConfigFeature</code> enum.</li>
<li><strong>Type Initialization</strong>: In the <code>static</code> initialization block of <code>ConfigFeature</code>, you MUST assign a <code>ValueType</code> to the <code>valueType</code> field of the new constant.<ul>
<li>Example: <code>REGISTRY_BASE_PATH.valueType = ValueType.STRING;</code></li>
</ul>
</li>
<li><strong>Default Values (Optional)</strong>: If the feature should have a default value, assign it to the <code>defaultValue</code> field in the same <code>static</code> block.<ul>
<li>Example: <code>MY_FEATURE.defaultValue = Boolean.TRUE;</code></li>
</ul>
</li>
<li><strong>Verification</strong>: Run the <code>ConfigFeatureTypesTest</code> unit test to ensure that all features have a valid type assigned. A missing type will cause a <code>NullPointerException</code> when the feature is accessed via <code>ConfigFactorySettings</code>.</li>
</ol>
<h2 id="4412-best-practices">4.4.12 Best Practices<a class="headerlink" href="#4412-best-practices" title="Permanent link">&para;</a></h2>
<h3 id="classpath-layout">Classpath Layout<a class="headerlink" href="#classpath-layout" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Production Defaults</strong>: <code>src/main/resources/.config/&amp;lt;company&amp;gt;/&amp;lt;app&amp;gt;/&amp;lt;config&amp;gt;.&amp;lt;ext&amp;gt;</code> (JARConfigSource).</li>
<li><strong>Test Mode</strong>: <code>src/test/resources/.config/&amp;lt;company&amp;gt;/&amp;lt;app&amp;gt;/</code> + <code>config/{SCOPE}</code> (overrides project).</li>
<li><strong>Schemes</strong>: Same path + <code>.scheme.json</code>.</li>
</ul>
<h3 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h3>
<ul>
<li>Implement <code>ConfigLoggingInterface</code> for structured logs (SLF4J/JUL/Logback).</li>
<li><strong>Avoid</strong>: <code>System.out.println</code> (blocks UI/threads).</li>
<li>Secrets auto-redacted.</li>
</ul>
<h3 id="secrets-handling">Secrets Handling<a class="headerlink" href="#secrets-handling" title="Permanent link">&para;</a></h3>
<ul>
<li>Retrieve: <code>SecretValue sv = config.getSecret(key)</code> (scheme-marked SECRET).</li>
<li>Use: <code>byte[] data = sv.getValue()</code>; <code>sv.erase()</code> post-use (secure wipe).</li>
<li>Storage: Formats preserve <code>SecretValue</code>; logs masked.</li>
</ul>
<p>See <a href="35_handling_secrets.html">Handling Secrets</a>.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="43_faq.html" class="btn btn-neutral float-left" title="4.3 FAQ"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="45_ai_guidance.html" class="btn btn-neutral float-right" title="4.5 AI Guidance">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="43_faq.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="45_ai_guidance.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script>var base_url = ".";</script>
    <script src="js/theme_extra.js"></script>
    <script src="js/theme.js"></script>
      <script src="search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
